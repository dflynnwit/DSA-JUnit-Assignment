name: GitHub Classroom Workflow

on: 
  push:
    branches: [ '**' ]

jobs:
  build:
    name: Autograding
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Compile project
        run: mvn clean compile
      
      - name: Run tests
        run: mvn test
        continue-on-error: true
      
      - name: Count @Test annotations in StudentGradeTest.java
        id: count-tests
        run: |
          TEST_COUNT=$(grep -E "^\s*@Test" src/test/java/com/setu/dsa/StudentGradeTest.java | wc -l)
          echo "Test count: $TEST_COUNT"
          echo "test_count=$TEST_COUNT" >> $GITHUB_OUTPUT
          if [ $TEST_COUNT -lt 8 ]; then
            echo "❌ FAILED: Only $TEST_COUNT @Test methods found. Minimum required: 8"
            exit 1
          else
            echo "✅ PASSED: Found $TEST_COUNT @Test methods (minimum 8 required)"
          fi
      
      - name: Check for @BeforeEach or @Before annotation
        id: check-setup
        run: |
          if grep -q "@BeforeEach\|@Before" src/test/java/com/setu/dsa/StudentGradeTest.java; then
            echo "✅ PASSED: Found @BeforeEach or @Before annotation"
          else
            echo "❌ FAILED: No @BeforeEach or @Before annotation found in StudentGradeTest.java"
            exit 1
          fi
      
      - name: Display test results summary
        if: always()
        run: |
          echo "============================================"
          echo "           TEST RESULTS SUMMARY"
          echo "============================================"
          if [ -f target/surefire-reports/*.txt ]; then
            echo "Test reports found:"
            for file in target/surefire-reports/*.txt; do
              echo "--- $(basename $file) ---"
              cat "$file"
              echo ""
            done
          else
            echo "No test reports found"
          fi
          echo "============================================"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: target/surefire-reports/
      
      - name: Check build status
        if: failure()
        run: |
          echo "============================================"
          echo "❌ BUILD FAILED"
          echo "============================================"
          echo "Please check the logs above for details."
          echo "Common issues:"
          echo "  - Compilation errors in your code"
          echo "  - Test failures"
          echo "  - Less than 8 @Test methods"
          echo "  - Missing @BeforeEach annotation"
          echo "============================================"
          exit 1
